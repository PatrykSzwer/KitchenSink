<link rel="import" href="/sys/polymer/polymer.html">
<link rel="import" href="/sys/juicy-draggable/juicy-draggable.html">


<template>
    <template is="dom-bind">
        <h2>Sortable list</h2>
        <table id="myTable" class="table  table-hover">
            <thead>
            <tr>
                <th>Name</th>
                <th></th>
            </tr>
            </thead>
            <tbody>
            <template is="dom-repeat" items="{{model.Persons}}" as="person">
                <tr id="drop">
                    <td>
                        <juicy-draggable position="static" dropselector="#drop" on-juicy-draggable-stop="itemDropped">
                            <div><img src="/KitchenSink/images/drag-icon.svg"/>{{person.Name}}</div>
                        </juicy-draggable>

                    </td>
                    <td>
                        <input type="image" src="/KitchenSink/images/thumbsUp.svg" disabled$="{{isFirstRow(person.OrdNumber$)}}" value="{{person.OrdNumber$::click}}" onclick="moveRow(this, true)" onmouseover="this.src = '/KitchenSink/images/thumbsUpSelected.svg';" onmouseout="this.src = '/KitchenSink/images/thumbsUp.svg';"/>
                        <input type="image" src="/KitchenSink/images/thumbsDown.svg" disabled$="{{isLastRow(person.OrdNumber$, model.Persons)}}" value="{{person.OrdNumber$::click}}" onclick="moveRow(this, false)" onmouseover="this.src = '/KitchenSink/images/thumbsDownSelected.svg';" onmouseout="this.src = '/KitchenSink/images/thumbsDown.svg';"/>
                    </td>
                </tr>
            </template>
            </tbody>
        </table>
    </template>

    <script>
        (function () {
            var script = document._currentScript || document.currentScript;
            var template = script.previousElementSibling;

            template.itemDropped = function (event) {
                if (!event.detail.dropElement) {
                    return;
                }

                var drag = event.detail.dragElement.parentNode.parentNode.parentNode; // Get whole <td> element
                var drop = event.detail.dropElement;

                if (drag === drop) {
                    return;
                }

                var nextSiblingToDrag = drag.nextElementSibling;

                if (nextSiblingToDrag === drop) {
                    moveRow(drop.children[1].children[0], true); // .children[1].children[0] gets thumbsUp input element
                    return;
                }

                // switch order values
                var tmp = drop.children[1].children[0].value;
                drop.children[1].children[0].value = drag.children[1].children[0].value;
                drag.children[1].children[0].value = tmp;

                drop.parentNode.insertBefore(drag, drop);
                drop.parentNode.removeChild(drop);
                drag.parentNode.insertBefore(drop, nextSiblingToDrag);
            };

            template.isFirstRow = function (ordNumber) {
                if (parseInt(ordNumber) === 1) {
                    return true;
                } else {
                    return false;
                }
            };

            template.isLastRow = function (ordNumber, personsArray) {
                var maxOrdNumber = personsArray.length;
                if (parseInt(ordNumber) === maxOrdNumber) {
                    return true;
                }

                return false;
            };
        })();

        function moveRow(caller, moveUp) {
            var row = caller.parentNode.parentNode,
                upperRow = row.previousElementSibling,
                lowerRow = row.nextElementSibling,
                parent = row.parentNode;

            if (moveUp) {
                caller.value--;
                caller.src = '/KitchenSink/images/thumbsUp.svg'; // Fix on unchanging icon on first row after swap
                parent.insertBefore(row, upperRow);
            } else {
                caller.value++;
                caller.src = '/KitchenSink/images/thumbsDown.svg'; // Fix on unchanging icon on last row after swap
                parent.insertBefore(lowerRow, row);
            }
        }
    </script>
</template>